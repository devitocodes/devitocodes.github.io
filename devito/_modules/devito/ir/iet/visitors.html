

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>devito.ir.iet.visitors &mdash; Devito 1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> Devito
          

          
          </a>

          
            
            
              <div class="version">
                0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../download.html">Download</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples.html">Example Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../devito.html">API Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Devito</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../devito.html">devito</a> &raquo;</li>
        
      <li>devito.ir.iet.visitors</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for devito.ir.iet.visitors</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Visitor hierarchy to inspect and/or create IETs.</span>

<span class="sd">The main Visitor class is adapted from https://github.com/coneoproject/COFFEE.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">attrgetter</span>

<span class="kn">import</span> <span class="nn">cgen</span> <span class="k">as</span> <span class="nn">c</span>

<span class="kn">from</span> <span class="nn">devito.cgen_utils</span> <span class="k">import</span> <span class="n">blankline</span><span class="p">,</span> <span class="n">ccode</span>
<span class="kn">from</span> <span class="nn">devito.exceptions</span> <span class="k">import</span> <span class="n">VisitorException</span>
<span class="kn">from</span> <span class="nn">devito.ir.support.space</span> <span class="k">import</span> <span class="n">Backward</span>
<span class="kn">from</span> <span class="nn">devito.tools</span> <span class="k">import</span> <span class="n">as_tuple</span><span class="p">,</span> <span class="n">filter_sorted</span><span class="p">,</span> <span class="n">flatten</span><span class="p">,</span> <span class="n">GenericVisitor</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FindNodes&#39;</span><span class="p">,</span> <span class="s1">&#39;FindSections&#39;</span><span class="p">,</span> <span class="s1">&#39;FindSymbols&#39;</span><span class="p">,</span> <span class="s1">&#39;MapExpressions&#39;</span><span class="p">,</span>
           <span class="s1">&#39;IsPerfectIteration&#39;</span><span class="p">,</span> <span class="s1">&#39;XSubs&#39;</span><span class="p">,</span> <span class="s1">&#39;printAST&#39;</span><span class="p">,</span> <span class="s1">&#39;CGen&#39;</span><span class="p">,</span>
           <span class="s1">&#39;Transformer&#39;</span><span class="p">,</span> <span class="s1">&#39;FindAdjacent&#39;</span><span class="p">,</span> <span class="s1">&#39;MapIteration&#39;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Visitor</span><span class="p">(</span><span class="n">GenericVisitor</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">visit_Node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reuse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A visit method to reuse a node, ignoring children.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">o</span>

    <span class="k">def</span> <span class="nf">maybe_rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A visit method that rebuilds nodes if their children have changed.&quot;&quot;&quot;</span>
        <span class="n">ops</span><span class="p">,</span> <span class="n">okwargs</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">operands</span><span class="p">()</span>
        <span class="n">new_ops</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span> <span class="ow">is</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="n">new_ops</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">o</span>
        <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">_rebuild</span><span class="p">(</span><span class="o">*</span><span class="n">new_ops</span><span class="p">,</span> <span class="o">**</span><span class="n">okwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">always_rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A visit method that always rebuilds nodes.&quot;&quot;&quot;</span>
        <span class="n">ops</span><span class="p">,</span> <span class="n">okwargs</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">operands</span><span class="p">()</span>
        <span class="n">new_ops</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">_rebuild</span><span class="p">(</span><span class="o">*</span><span class="n">new_ops</span><span class="p">,</span> <span class="o">**</span><span class="n">okwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PrintAST</span><span class="p">(</span><span class="n">Visitor</span><span class="p">):</span>

    <span class="n">_depth</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a representation of the Iteration/Expression tree as a string,</span>
<span class="sd">    highlighting tree structure and node properties while dropping non-essential</span>
<span class="sd">    information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PrintAST</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_retval</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;&gt;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;  &#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depth</span>

    <span class="k">def</span> <span class="nf">visit_Node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="n">o</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="k">def</span> <span class="nf">visit_Generable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="n">body</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;&lt;C.</span><span class="si">%s%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="n">body</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">element</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;&lt;Element</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="n">body</span>

    <span class="k">def</span> <span class="nf">visit_Callable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_depth</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_depth</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;&lt;Callable </span><span class="si">%s</span><span class="s1">&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">visit_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">visit_Block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_depth</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">header</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">body</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">footer</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">body</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_depth</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">visit_Iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_depth</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_depth</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">detail</span> <span class="o">=</span> <span class="s1">&#39;::</span><span class="si">%s</span><span class="s1">::</span><span class="si">%s</span><span class="s1">::</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">limits</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">offsets</span><span class="p">)</span>
            <span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">properties</span><span class="p">]</span>
            <span class="n">props</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">props</span><span class="p">)</span> <span class="k">if</span> <span class="n">props</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">detail</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">Iteration </span><span class="si">%s%s</span><span class="s2">&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">dim</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">detail</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">rhs</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;&lt;Expression </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="n">body</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Conditional</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_depth</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">then_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">then_body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_depth</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">else_body</span><span class="p">:</span>
            <span class="n">else_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">else_body</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;&lt;If </span><span class="si">%s</span><span class="s2">&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&lt;Else&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">condition</span><span class="p">,</span>
                                                              <span class="n">then_body</span><span class="p">,</span> <span class="n">else_body</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;&lt;If </span><span class="si">%s</span><span class="s2">&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">condition</span><span class="p">,</span> <span class="n">then_body</span><span class="p">)</span>


<div class="viewcode-block" id="CGen"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.CGen">[docs]</a><span class="k">class</span> <span class="nc">CGen</span><span class="p">(</span><span class="n">Visitor</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a representation of the Iteration/Expression tree as a :module:`cgen` tree.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_args_decl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate cgen declarations from an iterable of symbols and expressions.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">is_AbstractObject</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">is_Symbol</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;const </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">dtype_to_ctype</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">is_Tensor</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dtype_to_ctype</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                                   <span class="s1">&#39;*restrict </span><span class="si">%s</span><span class="s1">_vec&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">is_Dimension</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;const </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">dtype_to_ctype</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;void&#39;</span><span class="p">,</span> <span class="s1">&#39;*_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_args_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate cgen function call arguments from an iterable of symbols and</span>
<span class="sd">        expressions.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">is_Object</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">is_LocalObject</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&amp;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">is_Array</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">*)</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dtype_to_ctype</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">is_Symbol</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">is_TensorFunction</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_vec&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ccode</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="CGen.visit_ArrayCast"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.CGen.visit_ArrayCast">[docs]</a>    <span class="k">def</span> <span class="nf">visit_ArrayCast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build cgen type casts for an :class:`AbstractFunction`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">function</span>
        <span class="n">align</span> <span class="o">=</span> <span class="s2">&quot;__attribute__((aligned(64)))&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">ccode</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">symbolic_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>
        <span class="n">lvalue</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">POD</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;(*restrict </span><span class="si">%s</span><span class="s1">)</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">align</span><span class="p">))</span>
        <span class="n">rvalue</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1"> (*)</span><span class="si">%s</span><span class="s1">) </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dtype_to_ctype</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_vec&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">Initializer</span><span class="p">(</span><span class="n">lvalue</span><span class="p">,</span> <span class="n">rvalue</span><span class="p">)</span></div>

<div class="viewcode-block" id="CGen.visit_tuple"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.CGen.visit_tuple">[docs]</a>    <span class="k">def</span> <span class="nf">visit_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="p">)</span></div>

<div class="viewcode-block" id="CGen.visit_Block"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.CGen.visit_Block">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">Module</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">header</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">body</span><span class="p">),)</span> <span class="o">+</span> <span class="n">o</span><span class="o">.</span><span class="n">footer</span><span class="p">)</span></div>

<div class="viewcode-block" id="CGen.visit_List"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.CGen.visit_List">[docs]</a>    <span class="k">def</span> <span class="nf">visit_List</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">Module</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">header</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Collection</span><span class="p">(</span><span class="n">body</span><span class="p">),)</span> <span class="o">+</span> <span class="n">o</span><span class="o">.</span><span class="n">footer</span><span class="p">)</span></div>

<div class="viewcode-block" id="CGen.visit_Element"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.CGen.visit_Element">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">element</span></div>

<div class="viewcode-block" id="CGen.visit_Expression"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.CGen.visit_Expression">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="n">ccode</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                        <span class="n">ccode</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span></div>

<div class="viewcode-block" id="CGen.visit_Increment"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.CGen.visit_Increment">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Increment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> += </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ccode</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                                         <span class="n">ccode</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">dtype</span><span class="p">)))</span></div>

<div class="viewcode-block" id="CGen.visit_LocalExpression"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.CGen.visit_LocalExpression">[docs]</a>    <span class="k">def</span> <span class="nf">visit_LocalExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">Initializer</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dtype_to_ctype</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                             <span class="n">ccode</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">dtype</span><span class="p">)),</span>
                             <span class="n">ccode</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span></div>

<div class="viewcode-block" id="CGen.visit_ForeignExpression"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.CGen.visit_ForeignExpression">[docs]</a>    <span class="k">def</span> <span class="nf">visit_ForeignExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="n">ccode</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">expr</span><span class="p">))</span></div>

<div class="viewcode-block" id="CGen.visit_Call"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.CGen.visit_Call">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_call</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arguments</span><span class="p">)))</span></div>

<div class="viewcode-block" id="CGen.visit_Conditional"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.CGen.visit_Conditional">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Conditional</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="n">then_body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">then_body</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">else_body</span><span class="p">:</span>
            <span class="n">else_body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">else_body</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">ccode</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">condition</span><span class="p">),</span> <span class="n">then_body</span><span class="p">,</span> <span class="n">else_body</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">ccode</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">condition</span><span class="p">),</span> <span class="n">then_body</span><span class="p">)</span></div>

<div class="viewcode-block" id="CGen.visit_Iteration"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.CGen.visit_Iteration">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>

        <span class="c1"># Start</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">o</span><span class="o">.</span><span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">NameError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Bound</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">offsets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">o</span><span class="o">.</span><span class="n">offsets</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">NameError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># For backward direction flip loop bounds</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">Backward</span><span class="p">:</span>
            <span class="n">loop_init</span> <span class="o">=</span> <span class="s1">&#39;int </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">ccode</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
            <span class="n">loop_cond</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &gt;= </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">ccode</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
            <span class="n">loop_inc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> -= </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loop_init</span> <span class="o">=</span> <span class="s1">&#39;int </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">ccode</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
            <span class="n">loop_cond</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &lt;= </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">ccode</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
            <span class="n">loop_inc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> += </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Append unbounded indices, if any</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">uindices</span><span class="p">:</span>
            <span class="n">uinit</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ccode</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">symbolic_start</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">uindices</span><span class="p">]</span>
            <span class="n">loop_init</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">loop_init</span><span class="p">]</span> <span class="o">+</span> <span class="n">uinit</span><span class="p">))</span>
            <span class="n">ustep</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ccode</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">symbolic_incr</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">uindices</span><span class="p">]</span>
            <span class="n">loop_inc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">loop_inc</span><span class="p">]</span> <span class="o">+</span> <span class="n">ustep</span><span class="p">))</span>

        <span class="c1"># Create For header+body</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">For</span><span class="p">(</span><span class="n">loop_init</span><span class="p">,</span> <span class="n">loop_cond</span><span class="p">,</span> <span class="n">loop_inc</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>

        <span class="c1"># Attach pragmas, if any</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">pragmas</span><span class="p">:</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Module</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">pragmas</span> <span class="o">+</span> <span class="p">(</span><span class="n">handle</span><span class="p">,))</span>

        <span class="k">return</span> <span class="n">handle</span></div>

<div class="viewcode-block" id="CGen.visit_Callable"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.CGen.visit_Callable">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Callable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">decls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_decl</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">FunctionDeclaration</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">retval</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">decls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">FunctionBody</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">body</span><span class="p">))</span></div>

<div class="viewcode-block" id="CGen.visit_Operator"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.CGen.visit_Operator">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="c1"># Kernel signature and body</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
        <span class="n">decls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_decl</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">FunctionDeclaration</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">retval</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">decls</span><span class="p">)</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Statement</span><span class="p">(</span><span class="s2">&quot;return 0&quot;</span><span class="p">)]</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">FunctionBody</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="n">retval</span><span class="p">))</span>

        <span class="c1"># Elemental functions</span>
        <span class="n">esigns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">efuncs</span> <span class="o">=</span> <span class="p">[</span><span class="n">blankline</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">_func_table</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">local</span><span class="p">:</span>
                <span class="n">esigns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">FunctionDeclaration</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">_args_decl</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">parameters</span><span class="p">)))</span>
                <span class="n">efuncs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">ccode</span><span class="p">,</span> <span class="n">blankline</span><span class="p">])</span>

        <span class="c1"># Header files, extra definitions, ...</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">_headers</span><span class="p">]</span>
        <span class="n">includes</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Include</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">_includes</span><span class="p">]</span>
        <span class="n">includes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">blankline</span><span class="p">]</span>
        <span class="n">cglobals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">_globals</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">_compiler</span><span class="o">.</span><span class="n">src_ext</span> <span class="o">==</span> <span class="s1">&#39;cpp&#39;</span><span class="p">:</span>
            <span class="n">cglobals</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">Extern</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">signature</span><span class="p">)]</span>
        <span class="n">cglobals</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cglobals</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">blankline</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">Module</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="n">includes</span> <span class="o">+</span> <span class="n">cglobals</span> <span class="o">+</span>
                        <span class="n">esigns</span> <span class="o">+</span> <span class="p">[</span><span class="n">blankline</span><span class="p">,</span> <span class="n">kernel</span><span class="p">]</span> <span class="o">+</span> <span class="n">efuncs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FindSections"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindSections">[docs]</a><span class="k">class</span> <span class="nc">FindSections</span><span class="p">(</span><span class="n">Visitor</span><span class="p">):</span>

<div class="viewcode-block" id="FindSections.default_retval"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindSections.default_retval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_retval</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">()</span></div>

    <span class="sd">&quot;&quot;&quot;Find all sections in an Iteration/Expression tree. A section is a map</span>
<span class="sd">    from an iteration space (ie, a sequence of :class:`Iteration` obects) to</span>
<span class="sd">    a set of expressions (ie, the :class:`Expression` objects enclosed by the</span>
<span class="sd">    iteration space).</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FindSections.visit_tuple"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindSections.visit_tuple">[docs]</a>    <span class="k">def</span> <span class="nf">visit_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_retval</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="FindSections.visit_Node"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindSections.visit_Node">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_retval</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="FindSections.visit_Iteration"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindSections.visit_Iteration">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">)</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="FindSections.visit_Expression"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindSections.visit_Expression">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_retval</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="n">visit_Element</span> <span class="o">=</span> <span class="n">visit_Expression</span>
    <span class="n">visit_Call</span> <span class="o">=</span> <span class="n">visit_Expression</span></div>


<div class="viewcode-block" id="MapExpressions"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.MapExpressions">[docs]</a><span class="k">class</span> <span class="nc">MapExpressions</span><span class="p">(</span><span class="n">FindSections</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map :class:`Expression` and :class:`Call` objects in the Iteration/Expression</span>
<span class="sd">    tree to their respective section.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MapExpressions.visit_Call"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.MapExpressions.visit_Call">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_retval</span><span class="p">()</span>
        <span class="n">ret</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">as_tuple</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="n">visit_Expression</span> <span class="o">=</span> <span class="n">visit_Call</span>
    <span class="n">visit_Element</span> <span class="o">=</span> <span class="n">FindSections</span><span class="o">.</span><span class="n">visit_Node</span></div>


<div class="viewcode-block" id="MapIteration"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.MapIteration">[docs]</a><span class="k">class</span> <span class="nc">MapIteration</span><span class="p">(</span><span class="n">FindSections</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map each :class:`Iteration` object in the Iteration/Expression tree to the</span>
<span class="sd">    enclosed :class:`Expression` and :class:`Call` objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MapIteration.visit_Call"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.MapIteration.visit_Call">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_retval</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">as_tuple</span><span class="p">(</span><span class="n">queue</span><span class="p">):</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="n">visit_Expression</span> <span class="o">=</span> <span class="n">visit_Call</span>
    <span class="n">visit_Element</span> <span class="o">=</span> <span class="n">FindSections</span><span class="o">.</span><span class="n">visit_Node</span></div>


<div class="viewcode-block" id="FindSymbols"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindSymbols">[docs]</a><span class="k">class</span> <span class="nc">FindSymbols</span><span class="p">(</span><span class="n">Visitor</span><span class="p">):</span>

<div class="viewcode-block" id="FindSymbols.default_retval"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindSymbols.default_retval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_retval</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span></div>

    <span class="sd">&quot;&quot;&quot;Find symbols in an Iteration/Expression tree.</span>

<span class="sd">    :param mode: Drive the search. Accepted values are: ::</span>

<span class="sd">        * &#39;symbolics&#39;: Collect :class:`AbstractSymbol` objects.</span>
<span class="sd">        * &#39;free-symbols&#39;: Collect all free symbols.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rules</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;symbolics&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">functions</span><span class="p">,</span>
        <span class="s1">&#39;free-symbols&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">free_symbols</span><span class="p">,</span>
        <span class="s1">&#39;defines&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">as_tuple</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">defines</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;symbolics&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FindSymbols</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>

<div class="viewcode-block" id="FindSymbols.visit_tuple"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindSymbols.visit_tuple">[docs]</a>    <span class="k">def</span> <span class="nf">visit_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">filter_sorted</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="FindSymbols.visit_Iteration"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindSymbols.visit_Iteration">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>
        <span class="n">symbols</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filter_sorted</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span></div>

    <span class="n">visit_Block</span> <span class="o">=</span> <span class="n">visit_Iteration</span>
    <span class="n">visit_Conditional</span> <span class="o">=</span> <span class="n">visit_Iteration</span>

<div class="viewcode-block" id="FindSymbols.visit_Expression"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindSymbols.visit_Expression">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">filter_sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="n">o</span><span class="p">)],</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span></div>

    <span class="n">visit_ArrayCast</span> <span class="o">=</span> <span class="n">visit_Expression</span>
    <span class="n">visit_Call</span> <span class="o">=</span> <span class="n">visit_Expression</span></div>


<div class="viewcode-block" id="FindNodes"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindNodes">[docs]</a><span class="k">class</span> <span class="nc">FindNodes</span><span class="p">(</span><span class="n">Visitor</span><span class="p">):</span>

<div class="viewcode-block" id="FindNodes.default_retval"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindNodes.default_retval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_retval</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find :class:`Node` instances.</span>

<span class="sd">    :param match: Pattern to look for.</span>
<span class="sd">    :param mode: Drive the search. Accepted values are: ::</span>

<span class="sd">        * &#39;type&#39; (default): Collect all instances of type ``match``.</span>
<span class="sd">        * &#39;scope&#39;: Return the scope in which the object ``match`` appears.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rules</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">match</span><span class="p">,</span> <span class="n">o</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">match</span><span class="p">),</span>
        <span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">match</span><span class="p">,</span> <span class="n">o</span><span class="p">:</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;type&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FindNodes</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>

<div class="viewcode-block" id="FindNodes.visit_object"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindNodes.visit_object">[docs]</a>    <span class="k">def</span> <span class="nf">visit_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="FindNodes.visit_tuple"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindNodes.visit_tuple">[docs]</a>    <span class="k">def</span> <span class="nf">visit_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="FindNodes.visit_Node"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindNodes.visit_Node">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_retval</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div></div>


<div class="viewcode-block" id="FindAdjacent"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindAdjacent">[docs]</a><span class="k">class</span> <span class="nc">FindAdjacent</span><span class="p">(</span><span class="n">Visitor</span><span class="p">):</span>

<div class="viewcode-block" id="FindAdjacent.default_retval"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindAdjacent.default_retval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_retval</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;seen_type&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)])</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a mapper from nodes N in an Expression/Iteration tree to sequences of</span>
<span class="sd">    objects I = [I_0, I_1, ...] of type T, where N is the direct ancestor of</span>
<span class="sd">    the items in I and all items in I are adjacent nodes in the tree.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FindAdjacent</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">match</span>

<div class="viewcode-block" id="FindAdjacent.handler"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindAdjacent.handler">[docs]</a>    <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_retval</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="n">group</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;seen_type&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
                <span class="c1"># Reset the group, Iterations no longer adjacent</span>
                <span class="n">group</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Potential leftover</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="k">def</span> <span class="nf">_post_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="p">):</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;seen_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="FindAdjacent.visit_object"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindAdjacent.visit_object">[docs]</a>    <span class="k">def</span> <span class="nf">visit_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="FindAdjacent.visit_tuple"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindAdjacent.visit_tuple">[docs]</a>    <span class="k">def</span> <span class="nf">visit_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="p">)</span></div>

<div class="viewcode-block" id="FindAdjacent.visit_Node"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.FindAdjacent.visit_Node">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">o</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="p">)</span>
        <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;seen_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span>
        <span class="k">return</span> <span class="n">ret</span></div></div>


<div class="viewcode-block" id="IsPerfectIteration"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.IsPerfectIteration">[docs]</a><span class="k">class</span> <span class="nc">IsPerfectIteration</span><span class="p">(</span><span class="n">Visitor</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return True if an :class:`Iteration` defines a perfect loop nest, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="IsPerfectIteration.visit_object"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.IsPerfectIteration.visit_object">[docs]</a>    <span class="k">def</span> <span class="nf">visit_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="IsPerfectIteration.visit_tuple"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.IsPerfectIteration.visit_tuple">[docs]</a>    <span class="k">def</span> <span class="nf">visit_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="p">)</span></div>

<div class="viewcode-block" id="IsPerfectIteration.visit_Node"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.IsPerfectIteration.visit_Node">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="n">found</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">)</span></div>

<div class="viewcode-block" id="IsPerfectIteration.visit_Conditional"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.IsPerfectIteration.visit_Conditional">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Conditional</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="n">found</span><span class="p">,</span> <span class="n">nomore</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">)</span></div>

<div class="viewcode-block" id="IsPerfectIteration.visit_Iteration"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.IsPerfectIteration.visit_Iteration">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nomore</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">found</span> <span class="ow">and</span> <span class="n">nomore</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">nomore</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nomore</span><span class="o">=</span><span class="n">nomore</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Transformer"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.Transformer">[docs]</a><span class="k">class</span> <span class="nc">Transformer</span><span class="p">(</span><span class="n">Visitor</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an Iteration/Expression tree T and a mapper from nodes in T to</span>
<span class="sd">    a set of new nodes L, M : N --&gt; L, build a new Iteration/Expression tree T&#39;</span>
<span class="sd">    where a node ``n`` in N is replaced with ``M[n]``.</span>

<span class="sd">    In the special case in which ``M[n]`` is None, ``n`` is dropped from T&#39;.</span>

<span class="sd">    In the special case in which ``M[n]`` is an iterable of nodes, ``n`` is</span>
<span class="sd">    &quot;extended&quot; by pre-pending to its body the nodes in ``M[n]``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="p">{},</span> <span class="n">nested</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Transformer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nested</span> <span class="o">=</span> <span class="n">nested</span>

<div class="viewcode-block" id="Transformer.visit_object"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.Transformer.visit_object">[docs]</a>    <span class="k">def</span> <span class="nf">visit_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">o</span></div>

<div class="viewcode-block" id="Transformer.visit_tuple"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.Transformer.visit_tuple">[docs]</a>    <span class="k">def</span> <span class="nf">visit_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">visited</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span></div>

    <span class="n">visit_list</span> <span class="o">=</span> <span class="n">visit_tuple</span>

<div class="viewcode-block" id="Transformer.visit_Node"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.Transformer.visit_Node">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="p">:</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># None -&gt; drop `o`</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
                <span class="c1"># Iterable -&gt; inject `handle` into `o`&#39;s children</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">VisitorException</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
                    <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">children</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span>
                <span class="n">children</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span> <span class="o">+</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">_rebuild</span><span class="p">(</span><span class="o">*</span><span class="n">children</span><span class="p">,</span> <span class="o">**</span><span class="n">o</span><span class="o">.</span><span class="n">args_frozen</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Replace `o` with `handle`</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
                    <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">handle</span><span class="o">.</span><span class="n">children</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">handle</span><span class="o">.</span><span class="n">_rebuild</span><span class="p">(</span><span class="o">*</span><span class="n">children</span><span class="p">,</span> <span class="o">**</span><span class="n">handle</span><span class="o">.</span><span class="n">args_frozen</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">handle</span><span class="o">.</span><span class="n">_rebuild</span><span class="p">(</span><span class="o">**</span><span class="n">handle</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">children</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">_rebuild</span><span class="p">(</span><span class="o">*</span><span class="n">children</span><span class="p">,</span> <span class="o">**</span><span class="n">o</span><span class="o">.</span><span class="n">args_frozen</span><span class="p">)</span></div>

<div class="viewcode-block" id="Transformer.visit_Operator"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.Transformer.visit_Operator">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot apply a Transformer visitor to an Operator directly&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="XSubs"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.XSubs">[docs]</a><span class="k">class</span> <span class="nc">XSubs</span><span class="p">(</span><span class="n">Transformer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :class:`Transformer` that performs substitutions on :class:`Expression`s</span>
<span class="sd">    in a given tree, akin to SymPy&#39;s ``subs``.</span>

<span class="sd">    :param mapper: (Optional) dictionary defining the substitutions.</span>
<span class="sd">    :param replacer: (Optional) a function to perform the substitution. Defaults</span>
<span class="sd">                     to SymPy&#39;s ``subs``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replacer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">XSubs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replacer</span> <span class="o">=</span> <span class="n">replacer</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">mapper</span><span class="p">))</span>

<div class="viewcode-block" id="XSubs.visit_Expression"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.XSubs.visit_Expression">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">_rebuild</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">replacer</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">expr</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="printAST"><a class="viewcode-back" href="../../../../devito.ir.iet.html#devito.ir.iet.visitors.printAST">[docs]</a><span class="k">def</span> <span class="nf">printAST</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PrintAST</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span><span class="o">.</span><span class="n">_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Opesci

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../../',
              VERSION:'1',
              LANGUAGE:'en',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>